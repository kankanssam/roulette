<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>룰렛 돌리기</title>
  <style>
    :root{
      --bg:#f7f9fc; --card:#fff; --text:#1f2937; --muted:#6b7280; --ring:#e5e7eb;
      --blue:#1976d2; --red:#e53935; --green:#2e7d32; --shadow:0 10px 30px rgba(0,0,0,.08);
    }
    *{box-sizing:border-box}
    html,body{height:100%}
    body{margin:0;font-family:ui-sans-serif,system-ui,-apple-system,Segoe UI,Roboto,"Noto Sans KR","Apple SD Gothic Neo","Malgun Gothic",Arial,sans-serif;color:var(--text);background:var(--bg);overflow-x:hidden}
    .container{max-width:880px;margin:28px auto;padding:16px}
    .card{background:var(--card);border-radius:16px;box-shadow:var(--shadow);padding:clamp(16px,2.6vw,28px);border:1px solid var(--ring)}
    .title{display:flex;align-items:center;gap:12px;margin:0 0 14px;padding:2px 0;font-size:clamp(22px,3.2vw,36px);font-weight:800}
    .row{display:flex;gap:10px}
    .field{flex:1;min-width:0}
    .field input{width:100%;padding:14px 16px;border-radius:12px;border:1px solid var(--ring);background:#fff;font-size:16px}
    .field input::placeholder{color:#9aa3af}
    .btn{appearance:none;border:none;border-radius:12px;padding:12px 16px;color:#fff;font-weight:700;cursor:pointer;white-space:nowrap}
    .btn[disabled]{opacity:.6;cursor:not-allowed}
    .btn.blue{background:var(--blue)} .btn.red{background:var(--red)} .btn.green{background:var(--green)}
    .actions{display:flex;gap:10px;justify-content:center;margin-top:16px}
    .chips{display:flex;gap:8px;flex-wrap:wrap;margin-top:12px}
    .chip{padding:8px 10px;border-radius:999px;display:inline-flex;align-items:center;gap:8px;border:1px solid rgba(0,0,0,.12)}
    .chip button{border:none;width:20px;height:20px;border-radius:50%;display:grid;place-items:center;cursor:pointer}
    .layout{display:grid;gap:18px;grid-template-columns:1fr;align-items:start;margin-top:14px}
    @media (min-width:900px){.layout{grid-template-columns:minmax(360px,420px) 1fr}}
    .wheel-card{background:#fff;border:1px solid var(--ring);border-radius:16px;padding:16px;box-shadow:var(--shadow)}
    .wheel-wrap{position:relative;width:100%;aspect-ratio:1/1;display:grid;place-items:center}
    canvas{display:block;width:100%;height:100%}
    .pointer{position:absolute;top:6px;left:50%;transform:translateX(-50%);width:0;height:0;border-left:14px solid transparent;border-right:14px solid transparent;border-top:22px solid #ef5350;filter:drop-shadow(0 2px 4px rgba(0,0,0,.25))}
    .sub{color:var(--muted);font-size:14px;margin-top:6px}

    /* 결과 카드: 오른쪽 설명 아래, 가운데 정렬 + 팝 애니메이션 */
    .result-card{
      margin-top:14px;border-radius:16px;padding:18px;color:#fff;
      background: linear-gradient(135deg,#16a34a 0%,#22c55e 45%,#4ade80 100%); /* 스핀 결과로 동적 변경 */
      box-shadow:0 10px 30px rgba(22,163,74,.25);
      position:relative; overflow:hidden;
      transform: scale(.97); opacity:0; pointer-events:none;
      text-align:center; display:flex; flex-direction:column; align-items:center; justify-content:center; min-height:88px;
    }
    .result-card.show{animation:pop .45s cubic-bezier(.2,.8,.2,1) forwards;}
    @keyframes pop{to{transform:scale(1);opacity:1}}
    .result-badge{display:inline-block;background:rgba(255,255,255,.22);padding:6px 12px;border-radius:999px;font-weight:800;margin-bottom:6px}
    .result-title{font-weight:900;font-size:clamp(20px,3.4vw,28px);line-height:1.1;margin:4px 0 2px}
    .result-note{opacity:.9;font-size:13px}
    .confetti-dot{position:absolute;width:6px;height:6px;border-radius:50%;opacity:.75}
    .hidden{display:none}
  </style>
</head>
<body>
  <div class="container">
    <div class="card">
      <h1 class="title">🎲 룰렛 돌리기</h1>
      <div class="row">
        <div class="field">
          <input id="itemInput" type="text" placeholder="쉼표(,)로 구분하여 입력하세요 (예: 치킨,피자)" autocomplete="off"/>
        </div>
        <button id="addBtn" class="btn blue">추가</button>
        <button id="resetBtn" class="btn red">초기화</button>
      </div>
      <div id="chipList" class="chips" aria-live="polite"></div>

      <div class="layout">
        <!-- 왼쪽: 룰렛 -->
        <div>
          <div class="wheel-card">
            <div class="wheel-wrap">
              <div class="pointer" aria-hidden="true"></div>
              <canvas id="wheel"></canvas>
            </div>
          </div>
          <div class="actions">
            <button id="spinBtn" class="btn green">룰렛 돌리기</button>
          </div>
        </div>

        <!-- 오른쪽: 사용법 + 결과 카드 -->
        <div>
          <p class="sub" style="margin-top:0;line-height:1.6">
            1) 입력창에 항목을 쉼표로 구분하여 입력하거나, 한 항목씩 입력 후 <b>추가</b>를 누르세요.<br>
            2) <b>초기화</b> 버튼으로 언제든 새로 시작할 수 있어요.<br>
            3) 룰렛은 1/n로 분할되고 각 조각은 서로 다른 색으로 채워집니다.<br>
            4) 항목 이름은 위 칩에만 표시되며, 칩 텍스트는 배경 대비에 따라 흰/검 자동 전환됩니다.
          </p>

          <!-- 설명 아래의 당첨 카드 (우측 하단 영역) -->
          <section id="resultWrap" class="result-card hidden" role="status" aria-live="polite">
            <span class="result-badge">🎉 당첨!</span>
            <div id="resultText" class="result-title">—</div>
            <div class="result-note">최종 선택 항목!!</div>
          </section>
        </div>
      </div>
    </div>
  </div>

<script>
(() => {
  // Elements
  const input = document.getElementById('itemInput');
  const addBtn = document.getElementById('addBtn');
  const resetBtn = document.getElementById('resetBtn');
  const spinBtn = document.getElementById('spinBtn');
  const chipList = document.getElementById('chipList');
  const canvas = document.getElementById('wheel');
  const ctx = canvas.getContext('2d');

  // Result UI
  const resultWrap = document.getElementById('resultWrap');
  const resultText = document.getElementById('resultText');

  // State
  let items = [];
  let rotation = 0;     // radians
  let spinning = false;

  const TAU = Math.PI * 2;
  const norm = (a)=>{ a%=TAU; return a>=Math.PI? a-TAU : (a<-Math.PI? a+TAU : a); };

  // HiDPI fit
  function fitCanvas(){
    const dpr = window.devicePixelRatio || 1;
    const wrap = canvas.parentElement;
    const size = Math.min(wrap.clientWidth, wrap.clientHeight);
    canvas.width = Math.floor(size * dpr);
    canvas.height = Math.floor(size * dpr);
    canvas.style.width = size + 'px';
    canvas.style.height = size + 'px';
    ctx.setTransform(dpr,0,0,dpr,0,0);
    draw();
  }

  // Color mapping for slices (and chips)
  function hue(i,n){ const H=(i*360/Math.max(1,n))%360; return `hsl(${H} 72% 55%)`; }

  // Contrast helpers for chip text
  function hslToRgb(h, s, l){
    if (s === 0) return [l,l,l];
    const q = l < 0.5 ? l*(1+s) : l + s - l*s;
    const p = 2*l - q;
    const f = t=>{
      if(t<0) t+=1; if(t>1) t-=1;
      if(t<1/6) return p+(q-p)*6*t;
      if(t<1/2) return q;
      if(t<2/3) return p+(q-p)*(2/3-t)*6;
      return p;
    };
    return [f(h+1/3), f(h), f(h-1/3)];
  }
  function relLum(r,g,b){
    const lin = c => (c <= 0.03928 ? c/12.92 : Math.pow((c+0.055)/1.055, 2.4));
    return 0.2126*lin(r)+0.7152*lin(g)+0.0722*lin(b);
  }
  function textColorForIndex(i,n){
    const H=(i*360/Math.max(1,n))%360;
    const [r,g,b]=hslToRgb(H/360,0.72,0.55);
    return relLum(r,g,b) > 0.55 ? '#111827' : '#ffffff';
  }

  // === Winner theme (gradient matching the chip color) ===
  function applyWinnerThemeByIndex(idx, n) {
    const H = (idx * 360 / Math.max(1, n)) % 360; // chips와 동일 Hue
    const S = 72;
    const L = 55;

    // 3-stop gradient: 어둡게 → 기본 → 밝게
    const l1 = Math.max(0,  L - 18);
    const l2 = L;
    const l3 = Math.min(100, L + 16);

    const gradient = `linear-gradient(135deg,
      hsl(${H} ${S}% ${l1}% ) 0%,
      hsl(${H} ${S}% ${l2}% ) 45%,
      hsl(${H} ${Math.max(0, S - 12)}% ${l3}% ) 100%)`;

    resultWrap.style.background = gradient;

    // 박스 섀도우도 같은 계열로
    const [r, g, b] = hslToRgb(H/360, S/100, L/100);
    resultWrap.style.boxShadow =
      `0 10px 30px rgba(${Math.round(r*255)}, ${Math.round(g*255)}, ${Math.round(b*255)}, .28)`;
  }

  // Shuffle & random insert
  function shuffleInPlace(arr){
    for(let i=arr.length-1;i>0;i--){
      const j=Math.floor(Math.random()*(i+1));
      [arr[i],arr[j]]=[arr[j],arr[i]];
    }
  }
  function insertRandom(item){
    const idx=Math.floor(Math.random()*(items.length+1));
    items.splice(idx,0,item);
  }

  // Draw wheel (no labels)
  function draw(){
    const dpr = window.devicePixelRatio || 1;
    const w = canvas.width / dpr, h = canvas.height / dpr;
    const cx = w/2, cy = h/2, radius = Math.min(w,h)/2 - 14;

    ctx.clearRect(0,0,w,h);

    // rim
    ctx.beginPath(); ctx.arc(cx,cy,radius,0,TAU); ctx.lineWidth=12; ctx.strokeStyle='#d1d5db'; ctx.stroke();

    if(items.length===0){
      ctx.fillStyle='#9aa3af';
      ctx.font=`${Math.max(14, radius*0.14)}px system-ui, "Noto Sans KR"`;
      ctx.textAlign='center'; ctx.textBaseline='middle';
      ctx.fillText('항목을 입력하세요', cx, cy);
      return;
    }

    const n = items.length, step = TAU/n, startBase = -Math.PI/2 + rotation;

    // slices
    for(let i=0;i<n;i++){
      const s = startBase + i*step, e = s + step;
      ctx.beginPath(); ctx.moveTo(cx,cy); ctx.arc(cx,cy,radius-6,s,e); ctx.closePath();
      ctx.fillStyle = hue(i,n); ctx.fill();

      // divider
      ctx.beginPath(); ctx.moveTo(cx,cy); ctx.arc(cx,cy,radius-6,s,s+0.004);
      ctx.strokeStyle='rgba(0,0,0,.2)'; ctx.lineWidth=2; ctx.stroke();
    }

    // hub
    ctx.beginPath(); ctx.arc(cx,cy,Math.max(14, radius*0.06),0,TAU);
    ctx.fillStyle='#fff'; ctx.fill(); ctx.lineWidth=3; ctx.strokeStyle='#d1d5db'; ctx.stroke();
  }

  // UI
  function escapeHtml(s){ return s.replaceAll('&','&amp;').replaceAll('<','&lt;').replaceAll('>','&gt;').replaceAll('"','&quot;').replaceAll("'","&#039;"); }
  function buildChips(){
    chipList.innerHTML='';
    items.forEach((txt,idx)=>{
      const color = hue(idx, items.length);
      const tcolor = textColorForIndex(idx, items.length);
      const chip = document.createElement('span');
      chip.className='chip';
      chip.style.background=color;
      chip.style.color=tcolor;
      chip.innerHTML = `<span style="width:10px;height:10px;border-radius:50%;background:${color};display:inline-block;box-shadow:0 0 0 2px rgba(255,255,255,.35)"></span>${escapeHtml(txt)}`;
      const b=document.createElement('button');
      b.textContent='×';
      b.style.background = tcolor === '#ffffff' ? 'rgba(255,255,255,.25)' : 'rgba(0,0,0,.12)';
      b.style.color = tcolor;
      b.setAttribute('aria-label', `${txt} 삭제`);
      b.addEventListener('click', ()=>{
        if(spinning) return;
        items.splice(idx,1); rotation=0; hideResult(); draw(); buildChips();
      });
      chip.appendChild(b); chipList.appendChild(chip);
    });
  }

  function addItemsFromInput(){
    const raw=input.value.trim(); if(!raw) return;
    const parts=raw.split(',').map(s=>s.trim()).filter(Boolean); if(parts.length===0) return;
    if(items.length===0 && parts.length>1){ items.push(...parts); shuffleInPlace(items); }
    else if(parts.length===1){ insertRandom(parts[0]); }
    else { items.push(...parts); shuffleInPlace(items); }
    input.value=''; rotation=0; hideResult(); refresh();
  }
  function reset(){ items=[]; rotation=0; spinning=false; hideResult(); refresh(); }
  function refresh(){ buildChips(); draw(); }

  // Pretty result helpers
  function hideResult(){
    resultWrap.classList.add('hidden'); resultWrap.classList.remove('show');
  }
  function showResult(name, idx, n){
    resultText.textContent = name;

    // 카드 배경을 당첨 조각(칩)과 같은 Hue 계열로 적용
    applyWinnerThemeByIndex(idx, n);

    // 컨페티도 같은 색 계열로 톤 매칭
    [...resultWrap.querySelectorAll('.confetti-dot')].forEach(n=>n.remove());
    const H = (idx * 360 / Math.max(1, n)) % 360, S = 72, L = 55;
    const confColors = [
      '#ffffff',
      `hsl(${H} ${Math.max(0,S-10)}% ${Math.min(100, L+30)}%)`,
      `hsl(${H} ${S}% ${Math.min(100, L+40)}%)`,
      `hsl(${H} ${Math.max(0,S-20)}% ${Math.min(100, L+20)}%)`,
    ];
    for(let i=0;i<10;i++){
      const dot = document.createElement('span');
      dot.className='confetti-dot';
      dot.style.background = confColors[i % confColors.length];
      dot.style.left = (Math.random()*100)+'%';
      dot.style.top  = (Math.random()*100)+'%';
      resultWrap.appendChild(dot);
    }

    // 애니메이션 표시
    resultWrap.classList.remove('hidden');
    void resultWrap.offsetWidth;         // reflow for animation
    resultWrap.classList.add('show');
  }

  // Spin (12시 포인터가 당첨)
  function spin(){
    if(spinning || items.length===0) return;

    const snapshot = items.slice();
    const n = snapshot.length, step = TAU/n;

    spinning=true;
    addBtn.disabled=resetBtn.disabled=spinBtn.disabled=input.disabled=true;
    chipList.style.pointerEvents='none';
    hideResult();

    const targetIndex = Math.floor(Math.random()*n);
    const finalRotation = -(targetIndex*step + step/2);          // slice center -> 12시
    const extraTurns = 4 + Math.floor(Math.random()*3);           // 4,5,6
    const totalDelta = (finalRotation - rotation) + extraTurns*TAU;

    const duration = 3000 + Math.random()*800; const start=performance.now();
    const ease = t=>1-Math.pow(1-t,3);

    function frame(now){
      const t=Math.min(1,(now-start)/duration);
      rotation = rotation + totalDelta*ease(t);
      draw();
      if(t<1) requestAnimationFrame(frame); else finish();
    }
    function finish(){
      rotation = norm(rotation); draw();
      const x = ((-rotation - step/2) % TAU + TAU) % TAU;
      let idx = Math.round(x / step) % n; if(idx<0) idx+=n;
      const winner = snapshot[idx];
      showResult(winner, idx, n);
      spinning=false;
      addBtn.disabled=resetBtn.disabled=spinBtn.disabled=input.disabled=false;
      chipList.style.pointerEvents='';
    }
    requestAnimationFrame(frame);
  }

  // Events
  addBtn.addEventListener('click', addItemsFromInput);
  input.addEventListener('keydown', e=>{ if(e.key==='Enter') addItemsFromInput(); });
  resetBtn.addEventListener('click', reset);
  spinBtn.addEventListener('click', spin);
  window.addEventListener('resize', fitCanvas);

  fitCanvas();
})();
</script>
</body>
</html>
